#!/bin/bash
PATH="/usr/bin:/bin"
CONFIG_FILE="@sysconfdir@/acme.conf"
COMMON_FILE="@pkgdatadir@/libcommon.sh"
ACME_TINY_PY="@pkgdatadir@/acme_tiny.py"

source "${COMMON_FILE}" || {
	echo "Failed to include shared function file" >&2
	exit 1
}

[[ -f "${CONFIG_FILE}" ]] || {
	pr_error "Configuration file '${CONFIG_FILE}' not found"
	exit 1
}

source "${CONFIG_FILE}" || {
	pr_error "Configuration file '${CONFIG_FILE}' not readable"
	exit 1
}

[[ ${UID} -eq $(id -u "${ACME_USER}") ]] || {
	pr_error "This script needs to run as '${ACME_USER}'!"
	exit 1
}

[[ -f "${ACME_TINY_PY}" ]] || {
	pr_error "Could not find 'acme_tiny.py' ACME client in '@pkgdatadir@'"
	exit 1
}

PREREQS=( "${OPENSSL}" "${WGET}" )
for x in ${PREREQS[@]}
do
	[[ -x "${x}" ]] || {
		pr_error "Could not find required pre-requisite '${x}'"
		exit 1
	}
done

[[ -f "${ACCOUNT_KEY}" ]] || {
	pr_error "Account key missing"
	exit 1
}

[[ -d "${CERT_DIR}" ]] || {
	pr_error "Certificate dir not found"
	exit 1
}

[[ -d "${CHALLENGE_DIR}" ]] || {
	pr_error "ACME challenge dir not found"
	exit 1
}

#
# Search for letsencrypt signed certificates in CERT_DIR
#
FILES="$(find "${CERT_DIR}" -type f \( -name "*.crt" -or -name "*.pem" \))"
[[ -n "${FILES}" ]] || {
	pr_error "No certificate files found, nothing to do..."
	exit 1
}

UPDATED=0 FAILED=0 SKIPPED=0
CERTIFICATES=()
while read fn
do
	CERT_NAME="$(basename "${fn}")"

	acme_check_domain_cert "${fn}" || {
		(( SKIPPED++ ))
		continue
	}

	pr_info "Marking '${CERT_NAME}' for update..."
	CERTIFICATES+=( "${CERT_NAME}" )

done <<<"${FILES}"

[[ ${#CERTIFICATES[@]} -gt 0 ]] || {
	pr_info "No expiring letsencrypt certificate files found, nothing to do..."
	exit 1
}

for fn in ${CERTIFICATES[@]}
do
	CERT_NAME="${fn}"
	CERT_BASE="${CERT_NAME%.*}"
	[[ -f "${CERT_DIR}/${CERT_NAME}" ]] || {
		pr_error "Domain certificate '${CERT_NAME}' not found"
		(( FAILED++ ))
		continue
	}

	acme_handle_domain_cert "${CERT_DIR}/${CERT_BASE}.csr" "${CERT_DIR}/${CERT_BASE}.crt" || {
		(( FAILED++ ))
		continue
	}

	acme_handle_issuer_cert "${CERT_DIR}/${CERT_BASE}.crt" "${CERT_DIR}/${CERT_BASE}.ca-bundle" || {
		(( FAILED++ ))
		continue
	}

	(( UPDATED++ ))
done

pr_info "Found: ${#CERTIFICATES[@]}, Updated: ${UPDATED}, Skipped: ${SKIPPED}, Failed: ${FAILED}"

# Exitcode 0 indicates a least one cert has been updated, reload http server
[[ ${UPDATED} -gt 0 ]]; exit $?
